# Raspberry Pi 5 Fan Temperature Daemon

A daemon for Raspberry Pi 5 that monitors CPU and NVME temperatures and responds to polling requests from an Arduino-based fan controller.

## Overview

This daemon is designed to work with the [Raspberry Pi 5 Fan Controller](https://github.com/yourusername/rpi-fan-controller) project. It runs in the background on your Raspberry Pi 5 and listens for `POLL` commands on a serial port. When a poll command is received, it responds with the current CPU and NVME temperatures in the format `CPU:xx.xx|NVME:xx.xx`.

## Features

- **Daemon Process**: Runs in the background with minimal resource usage
- **Automatic Startup**: Starts automatically at boot via systemd
- **Temperature Monitoring**: Reports both CPU and NVME temperatures
- **Event-Based Design**: Uses blocking I/O with timeout for efficient CPU usage
- **Required Environment Configuration**: Enforces explicit configuration via environment variables
- **Logging**: Logs activity to syslog for easy troubleshooting

## Requirements

- Raspberry Pi 5
- Serial connection to Arduino fan controller (UART pins or USB-to-Serial adapter)
- Build dependencies: `build-essential`
- Runtime dependencies: Automatically installed by the configuration script as needed
  - `smartmontools` (for NVME temperature monitoring)

## Installation

### Standard Installation

The installation process consists of three simple steps:

1. Build the daemon:
   ```bash
   ./scripts/build.sh
   ```

2. Configure the daemon:
   ```bash
   sudo ./scripts/configure.sh
   ```

3. Install the daemon and service:
   ```bash
   sudo ./scripts/install.sh
   ```

The installation script will detect if you're updating an existing installation and will restart the service automatically.

### Debian Package Installation

For easier distribution and installation, you can build and use a Debian package:

1. Build the Debian package:
   ```bash
   make deb
   ```
   Or use the script directly:
   ```bash
   ./scripts/build_deb.sh
   ```

2. Install the package:
   ```bash
   sudo dpkg -i rpi5-fan-temp-daemon-1.0.0.deb
   sudo apt-get install -f  # To resolve any dependencies
   ```

The package installation will:
- Run the configuration script during the pre-installation phase
- Install the daemon binary to `/usr/local/bin`
- Install the systemd service file
- Enable and start the service

The configuration script is integrated directly into the package installation process, so there's no need for separate configuration steps.

To remove the package:
```bash
sudo apt-get remove rpi5-fan-temp-daemon
```

To completely remove the package including configuration:
```bash
sudo apt-get purge rpi5-fan-temp-daemon
```

### Manual Installation

If you prefer to install completely manually:

1. Install build dependencies:
   ```bash
   sudo apt-get update
   sudo apt-get install -y build-essential
   ```

2. Build the daemon:
   ```bash
   make
   ```

3. Create a configuration file at `/etc/fan-temp-daemon/config` with your settings.
   - Note: If you need NVME temperature monitoring, ensure `smartmontools` is installed:
     ```bash
     sudo apt-get install -y smartmontools
     ```

4. Install the daemon and service:
   ```bash
   sudo mkdir -p /etc/fan-temp-daemon
   sudo cp your-config-file /etc/fan-temp-daemon/config
   sudo cp bin/fan_temp_daemon /usr/local/bin/
   sudo cp scripts/fan-temp-daemon.service /etc/systemd/system/
   ```

5. Enable and start the service:
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable fan-temp-daemon.service
   sudo systemctl start fan-temp-daemon.service
   ```

## Configuration

The daemon uses a configuration file located at `/etc/fan-temp-daemon/config`. This file is automatically generated by the configuration script:

```bash
sudo ./scripts/configure.sh
```

The configuration script:
- Requires root privileges
- Automatically detects CPU and NVME temperature commands
- Tests the commands to ensure they work correctly
- Installs any necessary runtime dependencies (like `smartmontools` for NVME monitoring)
- Creates or overwrites the configuration file with appropriate values
- Restarts the service if it's already installed

The configuration file contains the following settings:

```
# Serial port to use
FAN_TEMP_SERIAL_PORT=/dev/serial0

# Baud rate (9600, 19200, 38400, 57600, 115200)
FAN_TEMP_BAUD_RATE=115200

# Timeout in seconds for reading from serial port
FAN_TEMP_READ_TIMEOUT=1

# Log to syslog (1) or stdout (0)
FAN_TEMP_LOG_TO_SYSLOG=1

# Command to get CPU temperature (auto-detected)
FAN_TEMP_CPU_CMD=/usr/bin/vcgencmd measure_temp

# Command to get NVME temperature (auto-detected)
FAN_TEMP_NVME_CMD=smartctl -A /dev/nvme0 | grep Temperature

# Run in foreground (1) or background (0)
FAN_TEMP_FOREGROUND=0

# Enable verbose logging (1) or not (0)
FAN_TEMP_VERBOSE=0
```

If you need to manually modify the configuration, edit this file and restart the service:

```bash
sudo nano /etc/fan-temp-daemon/config
sudo systemctl restart fan-temp-daemon.service
```

## Usage

Once installed, the daemon runs automatically in the background. You can control it using systemd commands:

```bash
# Check status
sudo systemctl status fan-temp-daemon.service

# Stop the daemon
sudo systemctl stop fan-temp-daemon.service

# Start the daemon
sudo systemctl start fan-temp-daemon.service

# Disable autostart
sudo systemctl disable fan-temp-daemon.service

# View logs
sudo journalctl -u fan-temp-daemon.service
```

## Uninstallation

To uninstall the daemon, use the provided uninstall script:

```bash
sudo ./scripts/uninstall.sh
```

This script will:
- Stop and disable the service
- Remove the binary from `/usr/local/bin`
- Remove the service file from `/etc/systemd/system`
- Remove the configuration directory at `/etc/fan-temp-daemon`
- Reload systemd

If you prefer to uninstall manually:

```bash
sudo systemctl stop fan-temp-daemon.service
sudo systemctl disable fan-temp-daemon.service
sudo rm /usr/local/bin/fan_temp_daemon
sudo rm /etc/systemd/system/fan-temp-daemon.service
sudo rm -rf /etc/fan-temp-daemon
sudo systemctl daemon-reload
```

## Hardware Connection

Connect your Raspberry Pi to the Arduino fan controller using the UART pins:

1. Raspberry Pi 5 UART pins:
   - **GPIO 14 (Pin 8)**: TX from Raspberry Pi → RX on Arduino
   - **GPIO 15 (Pin 10)**: RX on Raspberry Pi → TX on Arduino
   - **GND (Pin 6)**: Ground connection

2. Alternatively, use a USB-to-Serial adapter:
   - Connect the adapter to a USB port on the Raspberry Pi
   - Use the `-p` option to specify the correct port (e.g., `/dev/ttyUSB0`)

## Troubleshooting

### Serial Port Issues

If the daemon can't open the serial port:

1. Check that the port exists:
   ```bash
   ls -l /dev/serial0
   ```

2. Ensure the user has permission to access the port:
   ```bash
   sudo usermod -a -G dialout $USER
   ```

3. Try a different port with the `-p` option:
   ```bash
   fan_temp_daemon -p /dev/ttyAMA0
   ```

### Temperature Reading Issues

If temperature readings are incorrect:

1. For CPU temperature issues, check that `vcgencmd` is working:
   ```bash
   /usr/bin/vcgencmd measure_temp
   ```

2. For NVME temperature issues, check that `smartctl` is working:
   ```bash
   smartctl -A /dev/nvme0 | grep Temperature
   ```

## License

This project is released under the MIT License. See the LICENSE file for details. 

## Automated Builds

This project includes GitHub Actions workflows to automatically build the daemon and create Debian packages for ARM64 architecture:

### GitHub Actions

Two workflows are provided:

1. **Direct Cross-Compilation** (.github/workflows/build-arm64.yml):
   - Uses Ubuntu runner with cross-compilation tools
   - Builds the binary using aarch64-linux-gnu-gcc
   - Creates a Debian package for ARM64

2. **Docker-based Build** (.github/workflows/build-arm64-docker.yml):
   - Uses QEMU and Docker to build in an ARM64 environment
   - More reliable emulation of the target platform
   - Creates a Debian package in a controlled environment

The workflows are triggered:
- On push to the main branch
- On pull requests to the main branch
- Manually via the GitHub Actions interface

### Artifacts and Releases

Both workflows:
- Upload the Debian package as a build artifact
- Create a GitHub Release with the package when pushed to main

To download the latest package:
1. Go to the "Actions" tab in the GitHub repository
2. Select the latest successful workflow run
3. Download the artifact from the "Artifacts" section

Or download from the "Releases" section if you prefer stable releases. 